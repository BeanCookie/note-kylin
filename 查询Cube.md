# 查询Cube
Kylin的查询语言是基于标准SQL的，因为只有当查询查询数据与Cube定义的数据相匹配时，Kylin才能使用Cube的数据进行查询。“Group By”的列和“Where”条件里的列，必须是在维度中定义的列，而SQL中的度量，应该跟Cube中定义的度量一致。
在同一项目中如果有多个基于相同数据源的Cube并且他们都满足查询条件，则Kylin会基于“成本”选择一个“最优的”Cube进行查询。
#### Apache Calcite SQL简介
Apache Calcite是一个开源的SQL引擎，它提供了标准SQL语言解析、多种查询优化和连接各种数据源的能力。Calcite项目在Hadoop中越来越引人注目，并被众多项目集成为SQL解析器。
在Apache Kylin一条查询的执行过程主要分成四个部分：词法分析、逻辑执行计划、物理执行计划和执行。
1. 词法分析时Calcite将该查询拆分成包含关键词识别的字符段
2. Calcite根据词法分析的结果生成一个逻辑执行计划
3. Calcite会基于规则对逻辑执行计划进行优化，在优化的过程中根据这些规则将算子转化为对应的物理执行算子
4. 最后Calcite会根据这个执行计划动态生成执行代码，并到HBase中读取相对应的已经构建好的cuboid数据
#### 查询下压
正如上文所说只有当查询查询数据与Cube定义的数据相匹配时Kylin才能直接查询Cube中的数据，当查询语句不符合条件时Kylin会采用查询下压的方式进行查询。
查询下压的本质就是将不符合条件的查询使用Hive、Spark和Flink等构建引擎直接查询数据。一条查询经过解析后，进入查询路由，首先会进入Cube查询执行器中去寻找是否有能够回答该查询的Cube。如果没有找到合适的Cube，则会抛出异常“Norealization found.”，并将这个结果抛回查询路由，查询路由检测到该异常后，则会将该查询路由到一个外部查询引擎。