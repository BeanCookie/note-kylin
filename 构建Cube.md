# 构建Cube
新创建的Cube只有定义，而没有计算的数据，它的状态是“DISABLED”，是不会被查询引擎挑中的。要想让Cube有数据还需对它进行构建。
通常Cube可以有两种构建方式：全量构建与增量构建。这两种方式的实现逻辑都是一样的，区别只在于构建的数据源是全集还是子集。

#### 全量构建
因为全量构建会计算Cube中的所有数据，所有全量构建通常适用于不是按时间增加的数据，以及数据量比较少且更新评率不高的数据。

#### 增量构建
与全量构建不同，增量构建每次只会从Hive中读取指定时间范围内的数据进行计算，最终生成一个Segment。下次构建的时候，自动以上次结束的时间为起点时间，再选择新的终止时间进行构建。经过多次构建后，Cube中会有多个Segment依次按时间顺序进行排列，进行查询的时候，Apache Kylin会查询一个或多个Segment然后再做聚合计算。

#### 构建步骤
1. 创建Hive的中间平表
2. 重新分发中间表
3. 提取事实表的唯一列
4. 构建维度字典
5. 保存cuboid的统计数据和创建 HTable
6. 构建基础cuboid
7. 构建cube
8. 将cuboid数据转换为HFile
9. 将HFile导入HBase表
10. 更新cube信息
11. 清理资源

#### 刷新历史数据
当Hive中的原始数据变动时，想要在Cube中也查询到响应的变化就需要对Cube进行刷新。对于全量构建的Cube只需要刷新全部的数据，而对于增量构建的Cube则需要选择对应的Segment进行刷新。

#### 合并Segment
对于增量构建的Cube在查询数据时需要合并多个Segment，当Segment随着时间不断累加变得越来愈多时，会导致查询效率下降并且会对HBase集群造成极大的压力。因此需要定时对Segment进行合并。
合并有如下优势：1. 合并相同的Key从而减少Cube的存储空间。2. 减少Segment数量，可以减少查询时的二次聚合提高了查询性能。3. 减少HTable数量，降低Hbase压力。